window.onload = function () {
  addBotMessage("Xin ch√†o! üëã");
  addBotMessage("T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?");
  document.getElementById("suggestions").style.display = "block";
};

// ENTER ƒê·ªÇ G·ª¨I
document.getElementById("question").addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

// G·ª¨I V·ªÄ BACKEND
async function sendToBackend(question) {
  try {
    addLoading();

    const response = await fetch("http://localhost:4000/chat/api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question })
    });

    const data = await response.json();

    removeLoading();

    if (!data || !data.answer) {
      addBotMessage("Xin l·ªói, bot kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server.");
      return;
    }

    addBotMessage(data.answer);

  } catch (err) {
    console.error("L·ªói k·∫øt n·ªëi API:", err);
    removeLoading();
    addBotMessage("Bot ƒëang g·∫∑p s·ª± c·ªë k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.");
  }
}

// G·ª¨I SUGGESTION
function sendSuggestion(text) {
  document.getElementById("suggestions").style.display = "none";
  addUserMessage(text);
  sendToBackend(text);
}

// HI·ªÇN TH·ªä USER CHAT
function addUserMessage(text) {
  const div = document.createElement("div");
  div.className = "bubble user";
  div.textContent = text;
  document.getElementById("messages").appendChild(div);
  scrollMessages();
}

// HI·ªÇN TH·ªä BOT CHAT
function addBotMessage(text) {
  const div = document.createElement("div");
  div.className = "bubble bot";

  // Format tin cho d·ªÖ ƒë·ªçc
  text = text
    .replace(/\*\*(.*?)\*\*/g, "$1")
    .replace(/- /g, "‚Ä¢ ")
    .replace(/\d+\./g, o => "\n" + o)
    .replace(/\n{2,}/g, "\n")
    .trim();

  div.textContent = text;
  document.getElementById("messages").appendChild(div);
  scrollMessages();
}

// LOADING SPINNER
function addLoading() {
  const div = document.createElement("div");
  div.className = "bubble bot";
  div.id = "loading-bubble";
  div.innerHTML = `<div class="spinner"></div>`;
  document.getElementById("messages").appendChild(div);
  scrollMessages();
}

function removeLoading() {
  const el = document.getElementById("loading-bubble");
  if (el) el.remove();
}

// SCROLL BOTTOM
function scrollMessages() {
  const messages = document.getElementById("messages");
  messages.scrollTop = messages.scrollHeight;
}

// G·ª¨I TIN NH·∫ÆN CH√çNH
async function sendMessage() {
  const input = document.getElementById("question");
  const question = input.value.trim();
  if (!question) return;

  // ·∫®n g·ª£i √Ω
  const sug = document.getElementById("suggestions");
  if (sug && sug.style.display !== "none") {
    sug.style.display = "none";
  }

  addUserMessage(question);

  // CLEAR input ngay l·∫≠p t·ª©c
  input.value = "";

  await sendToBackend(question);
}

// TOGGLE SIDEBAR
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebar-overlay");
  const toggleBtn = document.getElementById("toggle-sidebar");

  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");

  if (sidebar.classList.contains("active")) {
    toggleBtn.classList.add("toggle-hidden");
  } else {
    toggleBtn.classList.remove("toggle-hidden");
  }
}
